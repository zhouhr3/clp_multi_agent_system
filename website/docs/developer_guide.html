<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>开发者文档 - 唇腭裂多智能体系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/styles.css" rel="stylesheet">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top">
        <div class="container">
            <a class="navbar-brand" href="../index.html">唇腭裂多智能体系统</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html#features">功能特点</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html#architecture">系统架构</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html#agents">智能体介绍</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="../index.html#docs">文档</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html#contact">联系我们</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 文档内容 -->
    <div class="container my-5">
        <div class="row">
            <div class="col-lg-3">
                <div class="doc-sidebar">
                    <h5 class="mb-3">目录</h5>
                    <nav class="nav flex-column">
                        <a class="nav-link" href="#environment">1. 开发环境设置</a>
                        <a class="nav-link" href="#code-structure">2. 代码结构</a>
                        <a class="nav-link" href="#core-components">3. 核心组件开发指南</a>
                        <a class="nav-link" href="#specialist-agents">4. 专科智能体开发指南</a>
                        <a class="nav-link" href="#system-integration">5. 系统集成与扩展</a>
                        <a class="nav-link" href="#testing">6. 测试指南</a>
                        <a class="nav-link" href="#performance">7. 性能优化</a>
                        <a class="nav-link" href="#troubleshooting">8. 故障排除</a>
                        <a class="nav-link" href="#versioning">9. 版本控制与发布</a>
                        <a class="nav-link" href="#contribution">10. 贡献指南</a>
                    </nav>
                </div>
            </div>
            <div class="col-lg-9">
                <div class="doc-content">
                    <h1 class="mb-4">唇腭裂多智能体系统开发者文档</h1>
                    
                    <section id="environment">
                        <h2>1. 开发环境设置</h2>
                        
                        <h3 class="h4 mt-4">1.1 系统要求</h3>
                        <ul>
                            <li>Python 3.10 或更高版本</li>
                            <li>至少 4GB RAM</li>
                            <li>互联网连接（用于API调用）</li>
                            <li>操作系统：Windows 10+, macOS 10.15+, 或 Linux (Ubuntu 20.04+推荐)</li>
                        </ul>
                        
                        <h3 class="h4 mt-4">1.2 依赖安装</h3>
                        <p>克隆代码库并安装依赖：</p>
                        <div class="bg-light p-3 rounded my-3">
                            <pre>
# 克隆代码库
git clone https://github.com/your-organization/cleft-multi-agent-system.git
cd cleft-multi-agent-system

# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/macOS
# 或
venv\Scripts\activate  # Windows

# 安装依赖
pip install -r requirements.txt
                            </pre>
                        </div>
                        
                        <h3 class="h4 mt-4">1.3 API密钥配置</h3>
                        <p>系统需要以下API密钥：</p>
                        <ol>
                            <li>OpenAI API密钥（用于语言模型调用）</li>
                            <li>PubMed API密钥（可选，用于医学文献搜索）</li>
                        </ol>
                        <p>创建<code>.env</code>文件并添加以下内容：</p>
                        <div class="bg-light p-3 rounded my-3">
                            <pre>
OPENAI_API_KEY=your_openai_api_key
PUBMED_API_KEY=your_pubmed_api_key
                            </pre>
                        </div>
                    </section>
                    
                    <section id="code-structure" class="mt-5">
                        <h2>2. 代码结构</h2>
                        <div class="bg-light p-3 rounded my-3">
                            <pre>
cleft_multi_agent_system/
├── docs/                     # 文档
├── src/                      # 源代码
│   ├── clp_agents/           # 智能体模块
│   │   ├── __init__.py
│   │   ├── agent.py          # 智能体基类
│   │   ├── agent_manager.py  # 智能体管理器
│   │   ├── api_integration.py # API集成
│   │   ├── cleft_agent.py    # 唇腭裂专科智能体
│   │   ├── craniofacial_agent.py # 颅面外科智能体
│   │   ├── genetic_agent.py  # 遗传学智能体
│   │   ├── knowledge_base.py # 知识库
│   │   ├── ophthalmology_agent.py # 眼科智能体
│   │   └── otology_agent.py  # 外耳智能体
│   ├── main.py               # 系统主程序
│   └── ui.py                 # 用户界面
├── tests/                    # 测试
│   ├── integration_test.py   # 集成测试
│   └── test_results/         # 测试结果
├── .env                      # 环境变量
├── README.md                 # 项目说明
└── requirements.txt          # 依赖列表
                            </pre>
                        </div>
                    </section>
                    
                    <section id="core-components" class="mt-5">
                        <h2>3. 核心组件开发指南</h2>
                        
                        <h3 class="h4 mt-4">3.1 Agent基类</h3>
                        <p>Agent基类(<code>agent.py</code>)是所有智能体的基础，定义了智能体的通用属性和方法。</p>
                        
                        <h4 class="h5 mt-3">主要属性</h4>
                        <ul>
                            <li><code>role</code>: 智能体角色</li>
                            <li><code>expertise</code>: 专业领域</li>
                            <li><code>description</code>: 详细描述</li>
                            <li><code>model_info</code>: 使用的语言模型信息</li>
                            <li><code>temperature</code>: 生成文本的随机性参数</li>
                            <li><code>messages</code>: 消息历史</li>
                            <li><code>activation_conditions</code>: 激活条件列表</li>
                        </ul>
                        
                        <h4 class="h5 mt-3">主要方法</h4>
                        <ul>
                            <li><code>add_message(role, content)</code>: 添加消息到历史</li>
                            <li><code>add_activation_condition(condition)</code>: 添加激活条件</li>
                            <li><code>check_activation(context)</code>: 检查是否应该激活智能体</li>
                            <li><code>_call_llm_api()</code>: 调用语言模型API</li>
                        </ul>
                        
                        <h4 class="h5 mt-3">扩展示例</h4>
                        <div class="bg-light p-3 rounded my-3">
                            <pre>
from clp_agents.agent import Agent

class NewSpecialistAgent(Agent):
    def __init__(
        self,
        model_info: str = "gpt-4o-mini",
        temperature: float = 0.7,
        api_key: Optional[str] = None
    ):
        super().__init__(
            role="新专科医生",
            expertise="新专科领域",
            description="专注于新专科领域的分析和治疗",
            model_info=model_info,
            temperature=temperature,
            api_key=api_key
        )
        
        # 添加激活条件
        self.add_activation_condition({
            "type": "symptom_present",
            "symptom": "相关症状"
        })
        
        # 添加系统提示
        self.add_message("system", self._get_system_prompt())
    
    def _get_system_prompt(self) -> str:
        return """
        你是一位经验丰富的新专科医生，专注于...
        """
    
    async def analyze_specific_condition(self, patient_data: Dict[str, Any]) -> Dict[str, Any]:
        # 实现专科分析逻辑
        pass
                            </pre>
                        </div>
                        
                        <h3 class="h4 mt-4">3.2 AgentManager</h3>
                        <p>AgentManager(<code>agent_manager.py</code>)负责智能体的招募、激活和协调。</p>
                        
                        <h4 class="h5 mt-3">主要方法</h4>
                        <ul>
                            <li><code>register_agent(agent_id, agent)</code>: 注册智能体</li>
                            <li><code>recruit_agents(context)</code>: 根据上下文招募智能体</li>
                            <li><code>coordinate_analysis(query)</code>: 协调智能体进行分析</li>
                            <li><code>_integrate_results(results)</code>: 整合分析结果</li>
                        </ul>
                        
                        <h4 class="h5 mt-3">自定义招募逻辑</h4>
                        <p>如需自定义招募逻辑，可以扩展<code>recruit_agents</code>方法：</p>
                        <div class="bg-light p-3 rounded my-3">
                            <pre>
async def recruit_agents(self, context: Dict[str, Any]) -> List[str]:
    """
    根据上下文招募智能体
    
    Args:
        context: 上下文信息
        
    Returns:
        List[str]: 激活的智能体ID列表
    """
    activated_agents = []
    
    # 添加自定义招募逻辑
    if "special_condition" in context:
        if "special_agent_id" in self.agents:
            activated_agents.append("special_agent_id")
    
    # 调用原有招募逻辑
    for agent_id, agent in self.agents.items():
        if agent_id not in activated_agents and await agent.check_activation(context):
            activated_agents.append(agent_id)
    
    return activated_agents
                            </pre>
                        </div>
                        
                        <h3 class="h4 mt-4">3.3 KnowledgeBase</h3>
                        <p>KnowledgeBase(<code>knowledge_base.py</code>)提供医学知识支持。</p>
                        
                        <h4 class="h5 mt-3">扩展知识库</h4>
                        <p>添加新的综合征信息：</p>
                        <div class="bg-light p-3 rounded my-3">
                            <pre>
def __init__(self):
    """初始化知识库"""
    self.syndromes = {
        # 现有综合征...
        
        # 添加新综合征
        "new_syndrome": {
            "info": {
                "name": "新综合征",
                "description": "新综合征的详细描述...",
                "inheritance": "遗传模式"
            },
            "symptoms": ["症状1", "症状2", "症状3"],
            "associated_genes": ["基因1", "基因2"],
            "treatment_guideline_id": "new_syndrome_treatment"
        }
    }
    
    self.treatment_guidelines = {
        # 现有治疗指南...
        
        # 添加新治疗指南
        "new_syndrome_treatment": {
            "title": "新综合征治疗指南",
            "recommendations": [
                {
                    "age": "0-6个月",
                    "procedures": ["推荐手术1", "推荐手术2"]
                },
                {
                    "age": "6-12个月",
                    "procedures": ["推荐手术3"]
                }
            ],
            "follow_up": "随访建议",
            "references": ["参考文献1", "参考文献2"]
        }
    }
                            </pre>
                        </div>
                        
                        <h3 class="h4 mt-4">3.4 APIIntegration</h3>
                        <p>APIIntegration(<code>api_integration.py</code>)与外部医学数据库和服务集成。</p>
                        
                        <h4 class="h5 mt-3">添加新的API集成</h4>
                        <div class="bg-light p-3 rounded my-3">
                            <pre>
async def query_new_service(self, query_params: Dict[str, Any]) -> Dict[str, Any]:
    """
    查询新服务
    
    Args:
        query_params: 查询参数
        
    Returns:
        Dict[str, Any]: 查询结果
    """
    if not self.session:
        raise RuntimeError("API客户端未初始化")
    
    api_key = self.api_keys.get("new_service")
    if not api_key:
        raise ValueError("缺少新服务API密钥")
    
    headers = {
        "Authorization": f"Bearer {api_key}",
        "Content-Type": "application/json"
    }
    
    url = "https://api.newservice.com/endpoint"
    
    try:
        async with self.session.post(url, json=query_params, headers=headers) as response:
            if response.status == 200:
                return await response.json()
            else:
                error_text = await response.text()
                raise RuntimeError(f"API请求失败: {response.status}, {error_text}")
    except Exception as e:
        raise RuntimeError(f"查询新服务时出错: {str(e)}")
                            </pre>
                        </div>
                    </section>
                    
                    <section id="specialist-agents" class="mt-5">
                        <h2>4. 专科智能体开发指南</h2>
                        
                        <h3 class="h4 mt-4">4.1 智能体结构</h3>
                        <p>每个专科智能体应包含以下部分：</p>
                        <ol>
                            <li><strong>初始化</strong>：设置角色、专业领域和激活条件</li>
                            <li><strong>系统提示</strong>：定义智能体的行为和知识范围</li>
                            <li><strong>分析方法</strong>：实现专科特定的分析逻辑</li>
                            <li><strong>辅助方法</strong>：提取和解析分析结果</li>
                        </ol>
                        
                        <h3 class="h4 mt-4">4.2 激活条件设计</h3>
                        <p>激活条件决定了智能体何时被招募，常见的激活条件类型包括：</p>
                        <ul>
                            <li><code>syndrome_type</code>: 综合征类型（syndromic/non-syndromic）</li>
                            <li><code>symptom_present</code>: 特定症状存在</li>
                            <li><code>age_range</code>: 年龄范围</li>
                            <li><code>severity</code>: 严重程度</li>
                        </ul>
                        
                        <p>示例：</p>
                        <div class="bg-light p-3 rounded my-3">
                            <pre>
# 综合征性唇腭裂时激活
self.add_activation_condition({
    "type": "syndrome_type",
    "syndrome_type": "syndromic"
})

# 特定症状存在时激活
self.add_activation_condition({
    "type": "symptom_present",
    "symptom": "耳部异常"
})

# 特定年龄范围激活
self.add_activation_condition({
    "type": "age_range",
    "min_age": 0,
    "max_age": 12,
    "unit": "month"
})
                            </pre>
                        </div>
                        
                        <h3 class="h4 mt-4">4.3 分析方法实现</h3>
                        <p>分析方法应遵循以下模式：</p>
                        <ol>
                            <li>构建分析提示</li>
                            <li>添加提示到消息历史</li>
                            <li>调用语言模型API</li>
                            <li>添加分析结果到消息历史</li>
                            <li>解析分析结果</li>
                        </ol>
                        
                        <p>示例：</p>
                        <div class="bg-light p-3 rounded my-3">
                            <pre>
async def analyze_specific_condition(self, patient_data: Dict[str, Any]) -> Dict[str, Any]:
    """
    分析特定条件
    
    Args:
        patient_data: 患者数据字典
        
    Returns:
        Dict[str, Any]: 分析结果
    """
    # 构建分析提示
    prompt = self._build_analysis_prompt(patient_data)
    
    # 添加提示到消息历史
    self.add_message("user", prompt)
    
    # 调用语言模型API
    analysis_result = await self._call_llm_api()
    
    # 添加分析结果到消息历史
    self.add_message("assistant", analysis_result)
    
    # 解析分析结果
    return self._parse_analysis_result(analysis_result)
                            </pre>
                        </div>
                    </section>
                    
                    <section id="system-integration" class="mt-5">
                     <response clipped><NOTE>To save on context only part of this file has been shown to you. You should retry this tool after you have searched inside the file with `grep -n` in order to find the line numbers of what you are looking for.</NOTE>